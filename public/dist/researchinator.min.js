/*!
  ____                               _     _             _
 |  _ \ ___  ___  ___  __ _ _ __ ___| |__ (_)_ __   __ _| |_ ___  _ __
 | |_) / _ \/ __|/ _ \/ _` | '__/ __| '_ \| | '_ \ / _` | __/ _ \| '__|
 |  _ <  __/\__ \  __/ (_| | | | (__| | | | | | | | (_| | || (_) | |
 |_| \_\___||___/\___|\__,_|_|  \___|_| |_|_|_| |_|\__,_|\__\___/|_|
*/
function nyplInterceptor(a,b){var c,d;return{request:function(a){return c=c||b.get("$http"),c.pendingRequests.length<1&&(d=d||b.get("requestNotificationChannel"),d.requestStarted()),a},response:function(a){return c=c||b.get("$http"),c.pendingRequests.length<1&&(d=d||b.get("requestNotificationChannel"),d.requestEnded()),a},responseError:function(e){return c=c||b.get("$http"),c.pendingRequests.length<1&&(d=d||b.get("requestNotificationChannel"),d.requestEnded()),a.reject(e)}}}nyplInterceptor.$inject=["$q","$injector"],angular.module("nypl_research_collections",["ngSanitize","ui.router","ngAnimate","locationService","coordinateService","angulartics","angulartics.google.analytics","nyplNavigation","nyplSSO","nyplBreadcrumbs","nyplSearch","ngAria","nyplAlerts"]).config(["$analyticsProvider","$crumbProvider","$httpProvider","$locationProvider","$stateProvider","$urlRouterProvider","$nyplAlertsProvider",function(a,b,c,d,e,f,g){"use strict";function h(a,b){return b.allDivisions().then(function(a){return a.divisions})["catch"](function(a){throw a})}function i(a){return a.getConfig()}function j(a){return a}a.virtualPageviews(!1),b.setOptions({primaryState:{name:"Home",customUrl:"http://nypl.org"}}),g.setOptions({api_root:locations_cfg.config.api_root,api_version:locations_cfg.config.api_version}),c.interceptors.push(nyplInterceptor),d.html5Mode(!0),e.state("home",{url:"/?subjects&media&locations",reloadOnSearch:!1,templateUrl:"views/research-collections.html",controller:"CollectionsCtrl",label:"Research Divisions",resolve:{config:i,divisions:h,params:j},data:{crumbName:"Research Divisions"}}).state("lost",{url:"/404",templateUrl:"views/404.html"}),f.otherwise("/"),f.rule(function(a,b){var c=b.url();return"/"===c[c.length-1]?c.slice(0,-1):void 0}),h.$inject=["config","nyplLocationsService"],i.$inject=["nyplLocationsService"],j.$inject=["$stateParams"]}]).run(["$analytics","$rootScope","$location",function(a,b,c){b.$on("$viewContentLoaded",function(){a.pageTrack("/research-divisions"),b.current_url=c.absUrl()})}]),function(a,b,c){"use strict";function d(){var a={url_undefined:"$nyplAlerts: API URL could not be defined",api:"$nyplAlerts: Alerts API could not retrieve data"},d={api_root:null,api_version:null};this.setOptions=function(a){b.extend(d,a)},this.$get=["$http","$q",function(b,e){var f={};return f.generateApiUrl=function(a,b){if(!a||!b)return c;var d="?callback=JSON_CALLBACK",e=a+"/"+b+"/alerts"+d;return 0===a.indexOf("http://")||0===a.indexOf("https://")?e:"http://"+e},f.getGlobalAlerts=function(){var c=e.defer(),f=this.generateApiUrl(d.api_root,d.api_version);return f?b.jsonp(f,{cache:!0}).success(function(a){c.resolve(a.alerts)}).error(function(){c.reject(a.api)}):c.reject(a.url_undefined),c.promise},f.alerts=null,f.api_url=d.api_root||null,f.api_version=d.api_version||null,f}]}function e(){var a={};return a.currentAlerts=function(a){var b,c,d=moment();return _.filter(a,function(a){return a.display&&a.display.start&&a.display.end&&(b=moment(a.display.start),c=moment(a.display.end),b.valueOf()<=d.valueOf()&&c.valueOf()>=d.valueOf())?a:void 0})},a.currentClosingAlerts=function(a){var b,c,d=moment();return _.filter(a,function(a){if(a.applies)if(a.applies.start&&a.applies.end){if(b=moment(a.applies.start),c=moment(a.applies.end),b.valueOf()<=d.valueOf()&&c.valueOf()>=d.valueOf())return a;if(d.toDate()===b.toDate()&&c.toDate()===d.toDate()&&c.valueOf()>=d.valueOf())return a}else if(a.applies.start&&(b=moment(a.applies.start),b.valueOf()<=d.valueOf()))return a})},a.currentWeekClosingAlerts=function(a){var b,c=moment().startOf("day"),d=moment().add(7,"days").startOf("day");return _.filter(a,function(a){if(a.applies&&a.applies.start){if(b=moment(a.applies.start),d.valueOf()>=b.valueOf()&&c.valueOf()<=b.valueOf())return a;if(c.valueOf()>=b.valueOf())return a}})},a.allClosingAlerts=function(a){return a?_.filter(a,function(a){return a.applies&&a.applies.start?a:void 0}):void 0},a.sortAlertsByScope=function(a){return a?_.chain(a).sortBy(function(a){return"all"===a.scope.toLowerCase()}).sortBy(function(a){return"location"===a.scope.toLowerCase()}).sortBy(function(a){return"division"===a.scope.toLowerCase()}).value():void 0},a.removeDuplicates=function(a){return a?_.chain(a).indexBy("id").flatten().uniq(function(a){return a.msg?a.msg.toLowerCase():void 0}).value():void 0},a.isAlertExpired=function(a,b){if(a&&b){var c=moment(a),d=moment(b),e=moment();return c.valueOf()<=e.valueOf()&&d.valueOf()>=e.valueOf()?!1:!0}},a.filterAlerts=function(a,b){if(a){var c=this.removeDuplicates(a),d={scope:b?b.scope||null:null,current:b?b.current||!1:!1,only_closings:b?b.only_closings||!1:!1};return d.scope&&(c=_.where(c,{scope:d.scope})),"all"===d.only_closings?c=this.allClosingAlerts(c):"current"===d.only_closings?c=this.currentClosingAlerts(c):"week"===d.only_closings?c=this.currentWeekClosingAlerts(c):(d.current===!0&&(c=this.currentAlerts(c)),c)}},a.getHoursOrMessage=function(a){if(a&&a.closedFn){var b=a.message||"",d=a.open||!1,e=a.hours||c,f=a.hoursFn,g=a.closedFn;return d?b?b:f(e):g()}},a.activeClosings=function(a){var b=this.filterAlerts(a,{only_closings:"current"});return b&&b.length?!0:!1},a.getCurrentActiveMessage=function(a){if(a){var b=this.filterAlerts(a,{only_closings:"current"}),c=_.chain(b).pluck("closed_for").first().value();return c}},a}function f(){return{restrict:"E",template:"<div class='nypl-global-alerts' data-ng-if='$root.alerts.length'><div data-ng-repeat='alert in $root.alerts'><p data-ng-bind-html='alert.msg'></p></div></div>",replace:!0,scope:!1}}function g(a){return{restrict:"E",template:"<div class='nypl-location-alerts' data-ng-if='locationAlerts.length'><div data-ng-repeat='alert in locationAlerts'><p data-ng-bind-html='alert.msg'></p></div></div>",replace:!1,scope:{alerts:"=alerts",type:"@"},link:function(b){b.alerts&&b.type.length&&(b.locationAlerts=a.filterAlerts(b.alerts,{scope:b.type,current:!0}))}}}function h(a,b,c){a.getGlobalAlerts().then(function(d){var e=b.alerts||d;b.alerts=c.filterAlerts(e,{current:!0}),a.alerts=b.alerts||d})["catch"](function(a){throw a})}f.$inject=["$rootScope"],g.$inject=["nyplAlertsService"],h.$inject=["$nyplAlerts","$rootScope","nyplAlertsService"],b.module("nyplAlerts",["ngSanitize"]).provider("$nyplAlerts",d).service("nyplAlertsService",e).run(h).directive("nyplLocationAlerts",g).directive("nyplGlobalAlerts",f)}(window,window.angular),function(a,b,c){"use strict";function d(){var a={primaryState:{name:null,customUrl:null},secondaryState:{name:null,customUrl:null}};this.setOptions=function(c){b.extend(a,c)},this.$get=["$state","$stateParams",function(b,c){var d=function(a,d){var e,f;for(e=0,f=a.length;f>e;e+=1)if(a[e].name===d.name)return;d["abstract"]||d.customUrl&&(d.url=b.href(d.name,c||{}),a.unshift(d))};return{getConfigChain:function(){var b=[];return a.secondaryState&&d(b,a.secondaryState),a.primaryState&&d(b,a.primaryState),b}}}]}function e(a,d,e){return{restrict:"E",templateUrl:"scripts/components/nypl_breadcrumbs/nypl_breadcrumbs.html",scope:{crumbName:"@"},link:function(f){function g(a,c){var d,e=a.split("."),f=c;for(d=0;d<e.length;d+=1)b.isDefined(f[e[d]])&&(f=f[e[d]]);return f}function h(a){var b,c=a;return a["abstract"]===!0&&("undefined"!=typeof f.abstractProxyProperty?(b=g(f.abstractProxyProperty,a),c=b?d.get(b):!1):c=!1),c}function i(b){var c,d,e;return f.crumbName?(d=g(f.crumbName,b),c="undefined"!=typeof b.locals?b.locals.globals:b,d===!1?!1:"undefined"==typeof d?b.name:c?e=a(d)(c):void 0):b.name}function j(a){var b,d,e,f,g=a,h=g.data.parentState,i={},j="undefined"!=typeof a.locals?a.locals.globals:a;return"object"==typeof j&&h&&j.$stateParams?(d=n(a),b=m(j,h),e=l(j),f=k(j),d&&b&&(i={displayName:d,route:b}),e&&f&&(i.division={name:e,route:f}),i?i:c):c}function k(a){var b,d,e=a,f="division";return"object"==typeof e?(Object.keys(e).forEach(function(a){"$stateParams"!==a&&(d=e[a])}),d._embedded!==c&&d._embedded.parent&&d._embedded.parent.slug?(b=d._embedded.parent.slug,f+'({ "'+f+'":"'+b+'"})'):c):c}function l(a){var b,d,e=a;return"object"==typeof e?(Object.keys(e).forEach(function(a){"$stateParams"!==a&&(d=e[a])}),d._embedded!==c&&d._embedded.parent&&d._embedded.parent.name?b=d._embedded.parent.name:c):c}function m(a,b){var d,e,f=a,g=b;return"object"==typeof f&&g?(Object.keys(f).forEach(function(a){"$stateParams"!==a&&(e=f[a])}),e.amenity?e.amenity.id&&(d=e.amenity.id):e._embedded&&e._embedded.location&&e._embedded.location.slug&&(d=e._embedded.location.slug),d?g+'({ "'+g+'":"'+d+'"})':g):c}function n(b){var e,f,g=b.data.parentState,h=d.get(g),i="undefined"!=typeof b.locals?b.locals.globals:b;if(h){if(e=a(h.data.crumbName)(i))return e;if("object"==typeof i)return Object.keys(i).forEach(function(a){"$stateParams"!==a&&(f=i[a])}),f.amenity?f.amenity.name&&(e=f.amenity.name):f._embedded&&f._embedded.location&&f._embedded.location.name&&(e=f._embedded.location.name),e?e:g}return c}function o(a,b){var c,d=!1;for(c=0;c<b.length;c++)b[c].route===a.name&&(d=!0);return d}function p(){var a,b,c,g,k=[],l=d.$current,m=e.getConfigChain();if(m)for(a=0;a<m.length;a+=1)k.push({displayName:m[a].name,route:m[a].customUrl});for(g=j(l),g&&(g.displayName&&g.route&&k.push({displayName:g.displayName,route:g.route}),g.division&&k.push({displayName:g.division.name,route:g.division.route}));l&&""!==l.name;)b=h(l),b&&(c=i(b),c===!1||o(b,k)||k.push({displayName:c,route:b.name})),l.parent&&(l=l.parent);f.breadcrumbs=k}f.breadcrumbs=[],""!==d.$current.name&&p(),f.$on("$stateChangeSuccess",function(){p()})}}}e.$inject=["$interpolate","$state","$crumb"],b.module("nyplBreadcrumbs",[]).provider("$crumb",d).directive("nyplBreadcrumbs",e)}(window,window.angular),function(){"use strict";function a(a,b){return{restrict:"E",templateUrl:"scripts/components/nypl_feedback/nypl_feedback.html",replace:!0,scope:{height:"@",width:"@",url:"@",side:"@"},link:function(c,d){var e="right";c.trusted_url=a.trustAsResourceUrl(c.url),c.feedback="Feedback","left"===c.side?(d.addClass("left"),e="left"):d.addClass("right"),b.$watch("close_feedback",function(a){a&&(b.close_feedback=!1,d.removeClass("open"),c.feedback="Feedback")}),d.find("a").click(function(){d.toggleClass("open"),c.feedback=d.hasClass("open")?"Close":"Feedback",c.$apply()})}}}a.$inject=["$sce","$rootScope"],angular.module("nyplFeedback",[]).directive("nyplFeedback",a)}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{activenav:"@"},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_navigation.html",link:function(d){$(".dropDown").hover(function(){$(this).addClass("openDropDown")},function(){$(this).removeClass("openDropDown")}),c.$watch("current_url",function(){d.logout_url="https://nypl.bibliocommons.com/user/logout?destination="+c.current_url}),$(".mobile-login").click(function(c){c.preventDefault(),a.logged_in()?b.location.href=d.logout_url:$(".sso-login").toggleClass("visible")}),d.menuLabel="Log In",a.logged_in()&&(d.menuLabel="Log Out")}}}function b(){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_navigation/nypl_collapsed_buttons.html",link:function(a,b){var c=b.find(".nav-open-button"),d=b.find(".search-open-button");c.click(function(){return $(this).toggleClass("open"),d.removeClass("open"),$("#search-block-form-input").removeClass("open-search"),$(".search-options-resp").removeClass("open"),$("#search-top").removeClass("open"),$("#main-nav").toggleClass("open-navigation"),$(".sso-login").removeClass("visible"),!1}),d.click(function(){return $(this).toggleClass("open"),c.removeClass("open"),$("#search-block-form-input").toggleClass("open-search"),$("#search-top").toggleClass("open"),$("#main-nav").removeClass("open-navigation"),$(".sso-login").removeClass("visible"),!1})}}}a.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplNavigation",[]).directive("nyplNavigation",a).directive("nyplCollapsedButtons",b)}(),function(){"use strict";function a(a){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_search/nypl_search.html",link:function(b,c){function d(a){var b=a.closest("li");return b.hasClass("search-the-catalog")?l.term.attr("placeholder",l.prompt.catalog):b.hasClass("search-the-website")?l.term.attr("placeholder",l.prompt.site):l.term.attr("placeholder",l.prompt.default_val)}function e(){return $.trim(l.term.val())}function f(a){return void 0===a&&(a="Please enter a search term"),l.term.addClass("error").attr("placeholder",a)}function g(){return l.term.removeClass("error").attr("placeholder","")}function h(){return!l.mobile_flag.is(":visible")}function i(a){return void 0===a&&(a=l.choices.find("input[type=radio]:checked").parent()),$.trim(a.text()).toLowerCase()}function j(b){var c,d=e();return void 0===b&&(b=i()),0===d.length?(f(),a.eventTrack("Empty Search",{category:"Header Search",label:""}),!1):("nypl.org"===b?(c=window.location.protocol+"//nypl.org/search/apachesolr_search/"+d,a.eventTrack("Submit Search",{category:"Header Search",label:d})):(c="http://nypl.bibliocommons.com/search?t=smart&q="+d+"&commit=Search&searchOpt=catalogue",a.eventTrack("Submit Catalog Search",{category:"Header Search",label:d})),window.location=c,!1)}function k(){angular.element("html").click(function(){c.find(".pseudo-select").removeClass("open"),c.find(".error").removeClass("error")});var b=c;l.term=b.find("#search-block-form-input"),l.search_button=b.find(".search_button"),l.choices=b.find(".pseudo-select"),l.mobile_flag=b.find(".search-button"),l.prompt={default_val:l.term.attr("placeholder"),catalog:"Search the catalog",site:"Search NYPL.org"},b.click(function(a){a.stopPropagation()}),b.find("#search-block-form").submit(function(){return l.search_button.click(),!1}),l.term.focus(function(){l.choices.addClass("open"),a.eventTrack("Focused",{category:"Header Search",label:"Search Box"})}),l.term.focus(function(){g()}),b.find(".search-button").click(function(){return j()}),l.choices.find("li input").click(function(){d(angular.element(this)),a.eventTrack("Select",{category:"Header Search",label:i()})}),l.choices.find("li").click(function(){h()&&(0===e().length?f():j(i(angular.element(this))))})}var l={};k()}}}a.$inject=["$analytics"],angular.module("nyplSearch",["angulartics","angulartics.google.analytics"]).directive("nyplSearch",a)}(),function(){"use strict";function a(a,b,c){return{restrict:"E",scope:{},replace:!0,templateUrl:"scripts/components/nypl_sso/nypl_sso.html",link:function(d){function e(d,e,f,g){var h="";a.remembered()&&(d.val(a.remember()),f.attr("checked",!0)),f.click(function(){$(this).is(":checked")||a.forget()}),c.$watch("current_url",function(){h=c.current_url}),g.click(function(c){var g="https://nypl.bibliocommons.com/user/login?destination=";c.preventDefault(),f.is(":checked")&&a.remember(d.val()),g+=h.replace("#","%23")+"&",g+="name="+d.val(),g+="&user_pin="+e.val(),b.location.href=g})}function f(b){var c={username:"#username",pin:"#pin",remember_checkbox:"#remember_me",login_button:"#login-form-submit"},d=$.extend({},c,b);a.logged_in()&&h.addClass("logged-in"),e($(d.username),$(d.pin),$(d.remember_checkbox),$(d.login_button))}function g(){c.$watch("current_url",function(){d.logout_url="https://nypl.bibliocommons.com/user/logout?destination="+c.current_url}),d.header_button_label="LOG IN",a.logged_in()&&(d.header_button_label=a.login(),i.addClass("logged-in")),i.click(function(){h.toggleClass("visible")})}{var h=$(".sso-login"),i=$(".login-button"),j=$(".email-input-field"),k=$("#header-news_signup input[type=submit]");$(".header-newsletter-signup")}j.focus(function(){$(".newsletter_policy").slideDown()}),j.blur(function(){$(".newsletter_policy").slideUp()}),k.click(function(){return""===j.val()?(j.focus(),!1):void 0}),f(),g()}}}function b(){var a={};return a.login=function(){return $.cookie("bc_username")},a.logged_in=function(){return!(!this.login()||null===this.login())},a.remember=function(a){return a?$.cookie("remember_me",a,{path:"/"}):$.cookie("remember_me")},a.remembered=function(){var a=this.remember();return!(!a||null===a)},a.forget=function(){return $.removeCookie("remember_me",{path:"/"})},a}a.$inject=["ssoStatus","$window","$rootScope"],angular.module("nyplSSO",[]).service("ssoStatus",b).directive("nyplSso",a)}(),function(){"use strict";function a(a,b){var c=null,d={};return d.geolocationAvailable=function(){return b.navigator||b.navigator.geolocation?!0:!1},d.getBrowserCoordinates=function(){var d=a.defer();return this.geolocationAvailable()?b.navigator.geolocation.getCurrentPosition(function(a){c=a.coords,d.resolve(c)},function(a){switch(a.code){case a.PERMISSION_DENIED:d.reject(new Error("Permission denied."));break;case a.POSITION_UNAVAILABLE:d.reject(new Error("The position is currently unavailable."));break;case a.TIMEOUT:d.reject(new Error("The request timed out."));break;default:d.reject(new Error("Unknown error."))}},{enableHighAccuracy:!0,timeout:5e3,maximumAge:6e5}):d.reject(new Error("Your browser does not support Geolocation.")),d.promise},d.getDistance=function(a,b,c,d){if(!(a&&d&&c&&d))return void 0;var e,f=Math.PI*a/180,g=Math.PI*c/180,h=b-d,i=Math.PI*h/180;return e=Math.sin(f)*Math.sin(g)+Math.cos(f)*Math.cos(g)*Math.cos(i),e=Math.acos(e),e=180*e/Math.PI,e=60*e*1.1515,Math.ceil(100*e)/100},d}a.$inject=["$q","$window"],angular.module("coordinateService",[]).factory("nyplCoordinatesService",a)}(),function(){"use strict";function a(a,b){var c,d,e="?callback=JSON_CALLBACK",f="Could not reach API",g={};return g.getConfig=function(){var a=b.defer();return d?a.resolve(d):(d=window.locations_cfg.config,d?(c=d.api_root+"/"+d.api_version,a.resolve(d)):a.reject(f+": config")),a.promise},g.allLocations=function(){var d=b.defer();return a.jsonp(c+"/locations"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": locations")}),d.promise},g.singleLocation=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": location")}),g.promise},g.allDivisions=function(){var d=b.defer();return a.jsonp(c+"/divisions?callback=JSON_CALLBACK",{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": division")}),d.promise},g.singleDivision=function(d){var g=b.defer();return a.jsonp(c+"/divisions/"+d+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": division")}),g.promise},g.amenities=function(d){var g=b.defer(),h=d?"/amenities/"+d:"/amenities";return a.jsonp(c+h+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": amenities")}),g.promise},g.amenitiesAtLibrary=function(d){var g=b.defer();return a.jsonp(c+"/locations/"+d+"/amenities"+e,{cache:!0}).success(function(a){g.resolve(a)}).error(function(){g.reject(f+": library-amenity")}),g.promise},g.alerts=function(){var d=b.defer();return a.jsonp(c+"/alerts"+e,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": site-wide alerts")}),d.promise},g.terms=function(){var d=b.defer();return a.jsonp(c+"/terms?callback=JSON_CALLBACK",{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject(f+": terms")}),d.promise},g}a.$inject=["$http","$q"],angular.module("locationService",[]).factory("nyplLocationsService",a)}(),function(){function a(a,b,c,d,e,f,g,h,i,j,k,l){function m(){a.globalClosingMessage,f.alerts&&f.alerts.length&&(a.globalClosingMessage=i.getCurrentActiveMessage(f.alerts))}function n(a){var b=i.activeClosings(a);return b?!0:!1}function o(a){return d("timeFormat")(k.hoursToday(a))}function p(){return"<b>Branch is temporarily closed.</b>"}function q(){return a.filter_results[0].active?a.filter_results[0].subterms?a.filter_results[0].subterms:[{id:a.filter_results[0].id}]:!1}function r(){return _.chain(a.filter_results).filter(function(a){return a.active&&"Subjects"!==a.label}).map(function(a){return a.id}).value()}function s(b){return _.chain(a.divisions).filter(function(a){var c=!1;return _.each(b,function(b){_.each(a.terms,function(a){c||(c=_.find(a.terms,function(a){return a.id===b.id}))})}),!!c}).sortBy(function(a){return a.name}).flatten().value()}function t(a,b){return _.chain(b).filter(function(b){var c=[];return _.each(a,function(a){var d=!1;_.each(b.terms,function(b){d||(d=_.find(b.terms,function(b){return b.id===a}),d&&c.push(!0))}),d||b._embedded.location.id===a&&c.push(!0)}),c.length===a.length}).sortBy(function(a){return a.name}).flatten().value()}function u(){var b=r(),c=[],d=q();a.showActiveFilters=b.length||d.length?!0:!1,c=d.length?s(d):a.divisions,a.filteredDivisions=0===b.length?c:t(b,c)}function v(b,c){var d,e="";return"Subjects"===b?(_.each(a.terms[0].terms,function(a){_.findWhere(a.terms,{name:c.name})&&(e=a.name+" - ")}),d=e+c.name):d="Locations"===b?c.short_name:c.name,d}function w(b){var c=a.activeCategory,d=v(c,b),f=_.findWhere(a.filter_results,{label:c,name:d});return f?(e.search(c.toLowerCase(),null),a["selected"+c+"Subterm"]=void 0,void _.each(a.filter_results,function(a){a.label===c&&(a.name="",a.active=!1,a.id=void 0,"Subjects"===a.label&&(a.subterms=void 0))})):void _.each(a.filter_results,function(a){a.label===c&&(a.name=d,a.active=!0,a.id=b.id,"Subjects"===a.label&&(a.name=d,a.subterms=b.terms))})}function x(b){a["selected"+a.activeCategory+"Subterm"]=b}var y,z=g.research_order||["SASB","LPA","SC","SIBL"],A=function(a){var b,c,d;_.each(a,function(a){a._embedded.alerts&&(b=a._embedded.alerts,c=i.getCurrentActiveMessage(b)),d={message:c,open:a.open,hours:a.hours,hoursFn:o,closedFn:p},a.closingMessageClass=n(b),a.todaysHoursDisplay=c?"Today:":"Today's Hours:",a.hoursOrClosingMessage=i.getHoursOrMessage(d)})},B=function(){return j.terms().then(function(b){var c=[];_.each(b.terms,function(a){var b=a.terms,d="Subjects"===a.name?0:1;c[d]={id:a.id,name:a.name,terms:b}}),c.push({name:"Locations",locations:a.divisionLocations}),a.terms=c,D()})},C=function(){return j.singleLocation("sibl").then(function(b){A([b.location]),y=b.location,y._embedded.location={id:"SIBL"},a.filteredDivisions.push(y),a.divisions.push(y),a.divisionLocations.push(y),_.each(a.divisionLocations,function(a){a.short_name=g.research_shortnames[a.id]})})},D=function(){E(),F(),G(),u()},E=function(){var b,c;l.subjects&&(_.each(a.terms[0].terms,function(a){var e;b||(a.name===d("unslugify")(l.subjects)?b=a:(e=_.findWhere(a.terms,{name:d("unslugify")(l.subjects)}),e&&(b=a,c=e)))}),b&&!c?(a.filter_results[0].name=b.name,a.filter_results[0].active=!0,a.filter_results[0].id=b.id,a.filter_results[0].subterms=b.terms):c?(a.filter_results[0].name=b.name+" - "+c.name,a.filter_results[0].active=!0,a.filter_results[0].id=c.id):e.search("subjects",null)),a.selectedSubjectsSubterm=_.indexOf(a.terms[0].terms,b)},F=function(){var b;l.media&&(b=_.findWhere(a.terms[1].terms,{name:d("unslugify")(l.media)}),b?(a.filter_results[1].name=b.name,a.filter_results[1].active=!0,a.filter_results[1].id=b.id):e.search("media",null)),a.selectedMediaSubterm=_.indexOf(a.terms[1].terms,b)},G=function(){var b;l.locations&&(b=_.findWhere(a.terms[2].locations,{slug:l.locations}),b?(a.filter_results[2].name=b.slug.charAt(0).toUpperCase()+b.slug.slice(1),a.filter_results[2].active=!0,a.filter_results[2].id=b.id):e.search("locations",null)),a.selectedLocationsSubterm=_.indexOf(a.terms[2].locations,b)};b.title="Research Divisions",a.filter_results=[{label:"Subjects",name:"",id:void 0,active:!1,subterms:void 0},{label:"Media",name:"",id:void 0,active:!1},{label:"Locations",name:"",id:void 0,active:!1}],_.each(h,function(a){var b=a._embedded.location;b.short_name=g.research_shortnames[b.id]}),a.divisions=h,a.terms=[],a.filteredDivisions=_.chain(h).sortBy(function(a){return a.name}).flatten().value(),a.divisionLocations=_.chain(h).pluck("_embedded").flatten().pluck("location").indexBy("id").sortBy(function(a){return k.researchLibraryOrder(z,a.id)}).flatten().value(),C().then(B),m(),A(h),a.selectCategory=function(b,c){return a.categorySelected===b?(a.categorySelected=void 0,void(a.activeCategory=void 0)):(a.activeCategory=c.name,void(a.categorySelected=b))},a.filterDivisionsBy=function(b,f){return"Locations"===a.activeCategory?e.search(a.activeCategory.toLowerCase(),f.slug):e.search(a.activeCategory.toLowerCase(),d("slugify")(f.name)),x(b),w(f),k.isMobile()&&c(function(){a.categorySelected=void 0,a.activeCategory=void 0},700),u()},a.removeFilter=function(b){e.search(b.label.toLowerCase(),null),a["selected"+b.label+"Subterm"]=void 0,b.active=!1,b.name="",b.id=void 0,u()}}a.$inject=["$scope","$rootScope","$timeout","$filter","$location","$nyplAlerts","config","divisions","nyplAlertsService","nyplLocationsService","nyplUtility","params"],angular.module("nypl_research_collections").controller("CollectionsCtrl",a)}(),function(){"use strict";function a(a){return{restrict:"A",link:function(b,c){var d=function(){c.addClass("show")},e=function(){c.removeClass("show")};c.hasClass("show")&&c.removeClass("show"),a.onRequestStarted(b,d),a.onRequestEnded(b,e)}}}function b(){function a(a,b,c){var d=c.collapse,e=c.className||"open",f=c.duration||"fast";a.$eval(d)||b.hide(),a.$watch(d,function(a,c){a!==c&&(a?b.stop(!0,!0).slideDown(f).addClass(e):b.stop(!0,!0).slideUp(f).removeClass(e))})}return{link:a,restrict:"A"}}function c(a){return{restrict:"E",templateUrl:"scripts/directives/templates/footer.html",replace:!0,scope:{},link:function(b,c){var d,e=c.find(".footerlinks a");e.click(function(){d=angular.element(this).attr("href"),a.eventTrack("Click",{category:"footer",label:d})}),b.year=(new Date).getFullYear()}}}function d(){return{restrict:"AE",templateUrl:"scripts/directives/templates/collapsible-filters.html",replace:!1,scope:{items:"=data",parentTermName:"=",filterItem:"&",filteredResults:"="},link:function(a,b){var c=b.find(".collapsible-control"),d=b.find(".collapsible-filters");a.toggleFilters=function(){c.hasClass("open")?(c.removeClass("open"),d.removeClass("open")):($(".collapsible-control").removeClass("open"),$(".collapsible-filters").removeClass("open"),c.addClass("open"),d.addClass("open"))},a.checkActiveFilter=function(b,c){return a.activeFilter=_.findWhere(b,{id:c})}}}}function e(){return{restrict:"A",scope:!1,link:function(a,b){b.click(function(){$(".collapsible-control").removeClass("open"),$(".collapsible-filters").removeClass("open")})}}}a.$inject=["requestNotificationChannel"],c.$inject=["$analytics"],angular.module("nypl_research_collections").directive("collapse",b).directive("closeSubMenu",e).directive("collapsibleFilters",d).directive("nyplFooter",c).directive("loadingWidget",a)}(),function(){"use strict";function a(a){function b(a){var b=a.split(":"),c=parseInt(b[0],10);return c}function c(a){var b=a.split(":"),c=(parseInt(b[0],10)+11)%12+1,d=b[1],e=b[0]>=12?"pm":"am";return c+":"+d+e}function d(c,d){var e,f,g,h,i,j;return d.length||(e=moment(d.applies.start),f=moment(d.applies.end),h=b(c.open),i=b(c.close),g=f.isAfter(e,"day")?!0:!1,j=g||alert.infinite===!0?"Closed *":e.hours()<=h&&f.hours()>=i?"Closed *":h<e.hours()&&i<=f.hours()?"Closing early *":i>f.hours()&&h>=e.hours()?"Opening late *":"Change in hours *"),a.trustAsHtml(j)}return function(a){var b,e=void 0!==a&&void 0!==a.today?a.today:a;return e?(b=e.alert||null,null===e.open?"Closed":b?d(e,b):c(e.open)+" - "+c(e.close)):(console.log("timeFormat() filter error: Argument is not defined or empty, verify API response for time"),"")}}function b(){return function(a){return new Date(a).toISOString()}}function c(){return function(a){return"string"==typeof a?a.replace(/(^|\s)([a-z])/g,function(a){return a.toUpperCase()}):a}}function d(){function a(a){return a=a.split(":"),_.object(["hours","mins","meridian","military"],[(parseInt(a[0],10)+11)%12+1,a[1],a[0]>=12?"pm":"am",parseInt(a[0],10)])}return function(b){var c,d,e,f,g,h,i,j=moment(),k=j.get("hour");return b?(e=b.today,f=b.tomorrow,e.open&&e.close?(e.open&&(c=a(e.open)),e.close&&(d=a(e.close)),null!==f.alert&&(i=f.alert.closed_for||null),null!==f.open&&(g=a(f.open)),null!==f.close&&(h=a(f.close)),k>=d.military?i?"Tomorrow: "+i:g&&h?"Open tomorrow "+g.hours+(0!==parseInt(g.mins,10)?":"+g.mins:"")+g.meridian+"-"+h.hours+(0!==parseInt(h.mins,10)?":"+h.mins:"")+h.meridian:"Closed today":k<c.military?"Open today "+c.hours+(0!==parseInt(c.mins,10)?":"+c.mins:"")+c.meridian+"-"+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian:"Open today until "+d.hours+(0!==parseInt(d.mins,10)?":"+d.mins:"")+d.meridian):(console.log("Obj is undefined for open/close properties"),"Closed today")):"Not available"}}function e(){return function(a,b,c){return"string"!=typeof a?a:a.length<200?a:(isNaN(b)&&(b=200),void 0===c&&(c="..."),a.length<=b||a.length-c.length<=b?a:String(a).substring(0,b-c.length)+c)}}function f(){return function(a){return a.replace(/\s+/g,"-").toLowerCase()}}function g(){return function(a){return c()(a.replace(/\-/g," "))}}a.$inject=["$sce"],angular.module("nypl_research_collections").filter("timeFormat",a).filter("dateToISO",b).filter("capitalize",c).filter("hoursTodayFormat",d).filter("truncate",e).filter("slugify",f).filter("unslugify",g)}(),function(){"use strict";function a(){var a={},b={};return a.setResearchValue=function(a,c){return b[a]=c,this},a.getResearchValues=function(){return b},a.resetResearchValues=function(){return b={},this},a}a.$inject=["$filter"],angular.module("nypl_research_collections").factory("researchCollectionService",a)}(),function(){"use strict";function a(a){var b="_START_REQUEST_",c="_END_REQUEST_",d={};return d.requestStarted=function(){a.$broadcast(b)},d.requestEnded=function(){a.$broadcast(c)},d.onRequestStarted=function(a,c){a.$on(b,function(a){c(a)})},d.onRequestEnded=function(a,b){a.$on(c,function(a){b(a)})},d}function b(a,b,c){var d={};return d.hoursToday=function(a,b){var c,d,e,f,g=new Date,h=g.getDay(),i=h+1;return b&&b.all_closings&&b.all_closings.length&&(d=b.all_closings),a&&(d&&d.length&&(f=_.find(d,function(a){return a.applies?(e=moment(a.applies.start),"all"===a.scope&&e.day()===i?a:"location"===a.scope&&e.day()===i?a:"division"===a.scope&&e.day()===i):void 0})),c={today:{day:a.regular[h].day,open:a.regular[h].open,close:a.regular[h].close},tomorrow:{day:a.regular[i%7].day,open:a.regular[i%7].open,close:a.regular[i%7].close,alert:f||null}}),c},d.formatDate=function(a,b){var c,d=["January","February","March","April","May","June","July","August","September","October","November","December"];if(this.numDaysFromToday=function(a,b){return Math.round((a.valueOf()-b.valueOf())/1e3/86400-.5)},a&&b){var e=new Date(a),f=new Date(b),g=new Date,h=this.numDaysFromToday(f,g);if(!h)return;c=365>=h?e.getTime()<=g.getTime()&&f.getTime()>=g.getTime()?"Now through "+d[f.getUTCMonth()]+" "+f.getUTCDate()+", "+f.getUTCFullYear():e.getTime()>g.getTime()&&f.getTime()>=g.getTime()?"Opening "+d[e.getUTCMonth()]+" "+e.getUTCDate()+", "+e.getUTCFullYear():d[e.getUTCMonth()]+" "+e.getUTCDate()+", "+e.getUTCFullYear()+" through "+d[f.getUTCMonth()]+" "+f.getUTCDate()+", "+f.getUTCFullYear():"Ongoing"}return c},d.branchException=function(a){var b={};if(a){if(!a.exceptions)return null;if(""!==a.exceptions.description.trim())return b.desc=a.exceptions.description,a.exceptions.start&&(b.start=a.exceptions.start),a.exceptions.end&&(b.end=a.exceptions.end),b}return null},d.getAddressString=function(a,b){if(!a)return"";var c=" ",d=a.name;return b&&(c="<br />",d="<a href='/locations/"+a.slug+"'>"+a.name+"</a>"),d+c+a.street_address+c+a.locality+", "+a.region+", "+a.postal_code},d.socialMediaColor=function(a){return _.each(a,function(a){switch(a.classes="icon-",a.site){case"facebook":a.classes+=a.site+" blueDarkerText";break;case"foursquare":a.classes+=a.site+" blueText";break;case"instagram":a.classes+=a.site+" blackText";break;case"twitter":a.classes+=a.site+"2 blueText";break;case"tumblr":a.classes+=a.site+"2 indigoText";break;case"youtube":case"pinterest":a.classes+=a.site+" redText";break;default:a.classes+=a.site}}),a},d.popupWindow=function(a,c,d,e){var f,g,h,i,j;a&&(f=void 0===d?"300":"string"==typeof d||d instanceof String?d:d.toString(),g=void 0===e?"500":"string"==typeof d||d instanceof String?e:e.toString(),a&&c?h=b.open(a,c,"menubar=1,resizable=1,width="+f+",height="+g):a&&(h=b.open(a,"","menubar=1,resizable=1,width="+f+",height="+g)),h&&(j=parseInt(f,10),i=parseInt(g,10),h.moveTo(screen.width/2-j/2,screen.height/2-i/2)))
},d.calendarLink=function(a,b,c){if(!a||!b||!c)return"";var d=b.title,e=b.start.replace(/[\-:]/g,""),f=b.end.replace(/[\-:]/g,""),g=b.body,h=b._links.self.href,i=c.name+" - "+c.street_address+" "+c.locality+", "+c.region+" "+c.postal_code,j="";switch(a){case"google":j="https://www.google.com/calendar/render?action=template&text="+d+"&dates="+e+"/"+f+"&details="+g+"&location="+i+"&pli=1&uid=&sf=true&output=xml";break;case"yahoo":j="https://calendar.yahoo.com/?v=60&TITLE="+d+"&ST="+e+"&in_loc="+i+"&in_st="+i+"&DESC="+g+"&URL="+h}return j},d.icalLink=function(a,c){if(!a||!c)return"";var d=(new Date).toJSON().toString().replace(/[\-.:]/g,""),e="http://nypl.org/"+a._links.self.href,f="BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//NYPL//NONSGML v1.0//EN\nMETHOD:PUBLISH\nBEGIN:VEVENT\nUID:"+(new Date).getTime()+"\nDTSTAMP:"+d+"\nATTENDEE;CN=My Self ;\nORGANIZER;CN=NYPL:\nDTSTART:"+a.start.replace(/[\-:]/g,"")+"\nDTEND:"+a.end.replace(/[\-:]/g,"")+"\nLOCATION:"+c+"\nDESCRIPTION:"+a.body+"\nURL;VALUE=URI:"+e+"\nSUMMARY:"+a.title+"\nEND:VEVENT\nEND:VCALENDAR",g="data:text/calendar;chartset=utf-8,"+encodeURI(f);return b.open(g),g},d.isMobile=function(){var a=b.matchMedia("(min-width: 480px)");return a.matches?!1:!0},d.calcDistance=function(a,b){if(!a)return[];var d={latitude:b.latitude||b.lat,longitude:b.longitude||b["long"]};return _.each(a,function(a){var b,e,f=[];a.geolocation&&a.geolocation.coordinates&&(f=a.geolocation.coordinates),b=a.lat||f[1],e=a["long"]||f[0],a.distance=c.getDistance(d.latitude,d.longitude,b,e)}),a},d.checkDistance=function(a){var b=_.pluck(a,"distance");return _.min(b)>25?!0:!1},d.returnHTML=function(b){return a.trustAsHtml(b)},d.divisionHasAppointment=function(a,b){return _.contains(a,b)},d.researchLibraryOrder=function(a,b){return _.indexOf(a,b)},d}a.$inject=["$rootScope"],b.$inject=["$sce","$window","nyplCoordinatesService"],angular.module("nypl_research_collections").factory("nyplUtility",b).factory("requestNotificationChannel",a)}();